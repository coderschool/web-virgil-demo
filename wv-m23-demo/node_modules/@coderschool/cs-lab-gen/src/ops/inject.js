const path = require("path");
const fs = require("fs-extra");
const createResult = require("./result");
const injector = require("./injector");

const inject = async (action, args, { logger, cwd }) => {
  const {
    attributes: { to, inject, remove_lines },
  } = action;

  const result = createResult("inject", to);

  if (!(inject && to)) {
    return result("ignored");
  }

  const absTo = path.resolve(cwd, to);

  if (!fs.existsSync(absTo)) {
    logger.err(`Cannot inject to ${to}: doesn't exist.`);
    return result("error", {
      error: `Cannot inject to ${to}: doesn't exist.`,
    });
  }

  const content = (await fs.readFile(absTo)).toString();
  const injectResult = injector(action, content, logger);

  await fs.writeFile(absTo, injectResult);

  if (!remove_lines) {
    logger.ok(`     inject: ${to}`);
  } else {
    logger.ok(`     remove_lines: ${to}`);
  }

  return result("inject");
};

module.exports = inject;
