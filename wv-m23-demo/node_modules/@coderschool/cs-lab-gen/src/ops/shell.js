const path = require("path");
const createResult = require("./result");

const notEmpty = (x) => x && x.length > 0;
const shell = async (action, args, config) => {
  const { logger, exec } = config;
  const { attributes, body } = action;
  const { sh, change_process_dir } = attributes;

  const result = createResult("shell", sh);
  if (notEmpty(sh)) {
    try {
      await exec(sh, body);
    } catch (error) {
      logger.err(error.stderr);
      if (!args.allowShellFailure && !args.a) process.exit(1);
    }

    if (change_process_dir) {
      const newWorkingDir = path.resolve(config.cwd, change_process_dir);
      config.cwd = newWorkingDir;
      process.chdir(newWorkingDir);
      logger.notice(`     change process dir to: ${config.cwd}`);
    }

    logger.ok(`     shell: ${sh}`);

    return result("executed");
  }
  return result("ignored");
};

module.exports = shell;
