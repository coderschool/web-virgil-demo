const createResult = require("./result");
const path = require("path");
const fs = require("fs-extra");

const add = async (action, args, { logger, cwd }) => {
  const {
    attributes: { to, inject, unless_exists, force },
    body,
  } = action;
  const result = createResult("add", to);

  if (!to || inject) {
    return result("ignored");
  }
  const absTo = path.resolve(cwd, to);
  const shouldNotOverwrite =
    !force && unless_exists !== undefined && unless_exists === true;
  const fileExists = fs.existsSync(absTo);

  if (shouldNotOverwrite && fileExists) {
    logger.warn(`     skipped: ${to}`);
    return result("skipped");
  }

  await fs.ensureDir(path.dirname(absTo));
  await fs.writeFile(absTo, body);

  logger.ok(`     ${force ? "FORCED" : "added"}: ${to}`);

  return result("added");
};

module.exports = add;
