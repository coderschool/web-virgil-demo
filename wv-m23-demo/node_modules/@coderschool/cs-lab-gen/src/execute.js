const resolve = require("./ops");
const fs = require("fs-extra");
const path = require("path");

const addPlural = (n) => (n > 0 ? "s" : "");

const execute = async (renderedSteps, args, config) => {
  const { logger } = config;
  const results = [];

  // logger.notice(JSON.stringify(renderedSteps, null, 2));
  // return results;

  if (args.outputSteps) {
    await fs.writeFile(
      "output_steps.json",
      JSON.stringify(renderedSteps, null, 2)
    );
  }

  logger.notice(
    `Executing ${renderedSteps.length} step${addPlural(renderedSteps.length)}`
  );

  for (const step of renderedSteps) {
    logger.notice(
      `  ${step.title} - ${step.actions.length} action${addPlural(
        step.actions.length
      )} - filename: ${path.basename(step.fileName)}`
    );

    if (
      args.stopAt !== undefined &&
      step.title.match(new RegExp(`STEP ${args.stopAt}`, "i"))
    ) {
      logger.log(`     force stop by --stop-at ${args.stopAt}`);
      process.exit(0);
    }

    if (
      args.skip !== undefined &&
      step.title.match(new RegExp(`STEP ${args.skip}`, "i"))
    ) {
      logger.log(`     skipped by --skip ${args.skip}`);
      continue;
    }

    for (const action of step.actions) {
      const op = resolve(action.attributes);
      results.push(await op(action, args, config));
    }
  }
  return results;
};

module.exports = execute;
