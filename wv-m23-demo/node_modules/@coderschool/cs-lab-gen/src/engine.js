const fs = require("fs-extra");
const path = require("path");
const yargs = require("yargs-parser");
const { VERSION } = require("./help");

const params = async (externalArgv) => {
  const argv = yargs(externalArgv);

  let [docPath] = argv._;
  if (!docPath) return { docPath };
  docPath = path.resolve(docPath);

  const { _, ...cleanArgv } = argv;

  const args = Object.assign({ docPath }, cleanArgv);

  return args;
};

const engine = async (argv, config) => {
  const { cwd, logger } = config;
  const args = Object.assign(await params(argv), { cwd });

  if (["-v", "--version"].includes(argv[0])) {
    logger.log(VERSION);
    process.exit(0);
  }

  const { docPath } = args;
  if (!docPath) throw new Error("Please specify path to the docs.");
  if (!fs.existsSync(docPath)) throw new Error(`Cannot find folder ${docPath}`);
  if (!(await fs.stat(docPath)).isDirectory())
    throw new Error(`${docPath} is not a folder`);

  logger.ok(`Loading markdowns from ${docPath}\n`);
  // lazy loading these dependencies gives a better feel once
  const render = require("./render");
  const execute = require("./execute");
  return execute(await render(args, config), args, config);
};

module.exports = engine;
